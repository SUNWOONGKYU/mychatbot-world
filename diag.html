<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>AI Diagnostics - My Chatbot World</title>
    <style>
        body {
            background: #0f172a;
            color: #f8fafc;
            font-family: sans-serif;
            padding: 20px;
        }

        .card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        pre {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .success {
            color: #10b981;
        }

        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>AI 연결 진단 도구</h1>
    <div class="card">
        <h3>1. API 키 로드 상태</h3>
        <div id="keyStatus">로드 중...</div>

        <h3>2. OpenRouter 연결 테스트</h3>
        <button onclick="testConnection()">연결 테스트 시작</button>
        <pre id="log">여기에 로그가 표시됩니다...</pre>
    </div>

    <script src="js/secrets.js"></script>
    <script>
        function log(msg, type = '') {
            const el = document.getElementById('log');
            const color = type === 'error' ? 'red' : (type === 'success' ? '#10b981' : '#10b981');
            el.innerHTML += `<div style="color: ${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        window.onload = () => {
            const key = localStorage.getItem('mcw_openrouter_key');
            const statusEl = document.getElementById('keyStatus');
            if (key) {
                statusEl.innerHTML = `<span class="success">✅ 로컬 저장소에 키가 있음:</span> <code>${key.substring(0, 10)}...${key.substring(key.length - 5)}</code> (길이: ${key.length})`;
            } else {
                statusEl.innerHTML = `<span class="error">❌ 저장된 키가 없음!</span>`;
            }

            if (typeof MCW_SECRETS !== 'undefined') {
                log("secrets.js 로드됨.");
            } else {
                log("secrets.js 로드 실패!", "error");
            }
        };

        async function testConnection() {
            const key = localStorage.getItem('mcw_openrouter_key');
            log(`테스트 시작... 사용 모델: meta-llama/llama-3.3-70b-instruct:free`);

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key.trim()}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "Diagnostic Tool"
                    },
                    body: JSON.stringify({
                        "model": "meta-llama/llama-3.3-70b-instruct:free",
                        "messages": [{ "role": "user", "content": "hello" }]
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    log("✅ 연결 성공! AI 응답: " + data.choices[0].message.content, "success");
                } else {
                    log(`❌ 연결 실패! 상태코드: ${res.status}`, "error");
                    log(`에러 내용: ${JSON.stringify(data)}`, "error");
                }
            } catch (e) {
                log(`❌ 네트워크 에러: ${e.message}`, "error");
            }
        }
    </script>
</body>

</html>